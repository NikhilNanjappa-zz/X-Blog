<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Thoughts on latest technologies">

    <title>Domain Driven Design Aggregates - Xebia Blog</title>

    <link rel="canonical" href="http://blog.xebia.in/2009/12/17/domain-driven-design-aggregates/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Xebia Blog</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    <!-- Post Header -->
<header class="intro-header" style="background-image: url('/img/default-blog-pic.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>Domain Driven Design Aggregates</h1>
                    
                    <span class="meta">Posted by vgupta on December 17, 2009</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">

        <div class="row">
          <!-- Go to www.addthis.com/dashboard to customize your tools -->
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=shekhargulati" async="async"></script>

            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
              <h4>Reading time about 4  minutes</h4>

              <h1>Domain Driven Design : Aggregates</h1>

<p>Every object has a lifecycle. Some objects take birth and die in a single method while others have a more complex and longer life. Typically, <strong>Domain Objects</strong> falls into the second category. The lifecycle of a domain object is shown below</p>

<p><img src="http://xebee.xebia.in/wp-content/uploads/2009/12/lifecycle-300x192.png" alt="lifecycle" title="lifecycle"></p>

<p>As the lifecycle of a domain model is complex, it is advisable to separate the domain logic from the lifecycle management logic. Furthermore, sometimes, grouping related objects to manage them as an entity is easier than managing each of them separately. <strong>Domain Driven Design(DDD)</strong> suggests to group related objects as <strong>Aggregates</strong> and to use <strong>Factories</strong> and <strong>Repositories</strong> to manage the lifecycle of the object. In this blog, I will discuss about the <strong>Aggregates</strong> and their design considerations.</p>

<p><strong>Aggregates</strong></p>

<p>In a software system, a common requirement can be to maintain the history of the changes to a user&#39;s payment information, like credit card number, cvv number, etc. Typically, this is done by creating an object for user&#39;s history and persisting it. This can be done as shown in the code below</p>

<p>[sourcecode language=&quot;java&quot;] void updatePaymentInformation(params...) { //service class method User user = User.get(id);</p>

<p>UserHistory userHistory = new UserHistory(user); //copy constructor to copy auditable fields userHistory.save();</p>

<p>user.setCreditCardNumber(); user.setCvvNumber(); user.save(); } [/sourcecode]</p>

<p>Above code seemingly easy, but logically, UserHistory does not have use without a user. The true identity of the UserHistory is the associated user. So, it is better to manage the UserHistory from the User object itself as shown in the code below.</p>

<p>[sourcecode language=&quot;java&quot;] class User { Set<UserHistory> userHistories; void updatePaymentInformation(params..) { //user class method this.setCreditCardNumber(...); this.setCvvNumber(...) userHistories.add(new UserHistory(this)); } } [/sourcecode]</p>

<p>In above example, we can see that UserHistory cannot exist without User. So, we can enforce the access to UserHistory through User object only. This will minimize the dependencies between the classes and reduce complexity. The example mentioned in here in trivial, but in real world, there can be many other scenarios where one entity can also exist without another entity, like an Order item cannot exist without an Order, a Book cannot exist without a page. One important thing to note here is that in these examples, the reverse relation is also important, i.e., an Order does not have a meaning without a Order item and nobody will read a book without pages. Here, Book and Order represent a cluster of associated objects, which model something meaningful as a whole but lose importance when separated from each other.</p>

<p>In DDD, such cluster of associated objects is known as a <strong>Aggregate</strong>. Each aggregate has a <strong>root</strong> and a <strong>conceptual boundary</strong>. Root is a specific entity in the aggregate and is the only member of the aggregate visible(allowed to get referred from other objects) to rest of the world. Entities other than the Root entity are local entities, which have identities to distinguish them within the aggregate.</p>

<p>Other than managing the access to local entities of the aggregate, root of the aggregate can also enforce the <strong>invariants</strong>, which are consistency rules which needs to be maintained whenever data changes. For example, in most Purchase Orders(PO) there is a approval limit. So, whenever a new PO item is added to the PO, we can check whether adding the item will make PO exceed it&#39;s approval limit.</p>

<p>Since aggregates model a concept which represent a meaningful whole, consistency of aggregates are very important. To maintain consistency of aggregates, we need to apply a set of rules, which are </p>

<ul>
<li>The root entity should be the only window to the aggregate to the outside world.</li>
<li>All local entities within the aggregate should be accessed by traversing the tree from the root entity.</li>
<li>Invariants, if any, should be applied only by the root entity. Invariants should be applied at all times, i.e, whenever a non root member of the aggregate is inserted, update or deleted, all applicable invariants should be satisfied.</li>
<li>Any object which is outside the aggregate should not have references to entity or value objects which are member of the aggregate. The only exception to this rule is root entity.</li>
<li>Any update to the non root member should we through root entity as it would help in satisfying the aggregates.
In this blog, we discussed about the Aggregates and the set of rules to be applied while designing them. Although, an aggregate is a cluster of different objects, they represent a business concept as a unit. On the face of it, Aggregates seem to reduce the complexity of the model and make the model clean. But, we should avoid overuse of aggregates. We should avoid overuse of aggregates because </li>
<li>Overuse would result in deep nested trees and this would require a longer traversal time to the local entities.</li>
<li>In a distributed environment, serialization and de-serialization would take time if we have deeply nested structures.
Modelling aggregates judiciously would reduce the complexity and maintain consistency of the domain model.</li>
</ul>


                <hr>

                <div id="disqus_thread"></div>
<script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'xebiaww'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

                <hr>

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2009/12/14/migration-strategies/" data-toggle="tooltip" data-placement="top" title="Migration Strategies">&larr; Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2009/12/17/product-backlog-of-successful-engagement/" data-toggle="tooltip" data-placement="top" title="Product Backlog Of Successful Engagement">Next Post &rarr;</a>
                    </li>
                    
                </ul>

            </div>
        </div>
    </div>
</article>

<hr>


    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="https://twitter.com/XebiaIndia">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://www.facebook.com/XebiaIndia">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://github.com/xebiaww">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
                <p class="copyright text-muted">Copyright &copy; Xebia Blog 2015</p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/clean-blog.min.js "></script>


</body>

</html>
