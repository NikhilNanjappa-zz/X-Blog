<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Thoughts on latest technologies">

    <title>Groovy Client For Apache Cassandra - Xebia Blog</title>

    <link rel="canonical" href="http://blog.xebia.in/2010/09/14/groovy-client-for-apache-cassandra/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Xebia Blog</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    <!-- Post Header -->
<header class="intro-header" style="background-image: url('/img/default-blog-pic.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>Groovy Client For Apache Cassandra</h1>
                    
                    <span class="meta">Posted by rrawat on September 14, 2010</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">

        <div class="row">
          <!-- Go to www.addthis.com/dashboard to customize your tools -->
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=shekhargulati" async="async"></script>

            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
              <h4>Reading time about 4  minutes</h4>

              <h1>Groovy client for Apache Cassandra</h1>

<p>I have been exploring <a href="http://cassandra.apache.org/" title="Apache Cassandra">Apache Cassandra</a> recently for implementation of a project. Cassandra is a NoSQL (not only SQL) database open sourced by Facebook.</p>

<p>This blog shares a Groovy implementation of a Cassandra client which makes accessing Cassandra as simple as accessing a HashMap. The Groovy implementation is currently a wrapper on the basic <a href="http://incubator.apache.org/thrift/" title="Apache Thrift">Thrift </a>API. The map keys serve as the query language to perform slices and range queries.</p>

<p>Cassandra provides a <a href="http://incubator.apache.org/thrift/" title="Apache Thrift">Thrift </a>based interface which makes it accessible from different languages. It is similar to a WSDL file for Web Service which can be used to generate code clients in different languages.  There are two open source wrappers on Thrift API to access Cassandra:- </p>

<ol>
<li><a href="http://code.google.com/p/cassandra-java-client/">Cassandra Java Client</a></li>
<li><a href="http://github.com/rantav/hector">Hector</a>
Cassandra Java Client is too basic. Hector is a good option as it provides features like pooling and is JMX enabled.</li>
</ol>

<p>I tried the Java thrift API and Hector but it looks too cumbersome and verbose if you wrote code in Groovy or another programming language. Following is the sample groovy test code compared to Thrift based <a href="http://wiki.apache.org/cassandra/ThriftExamples#Java" title="Java example">Java example.</a>.</p>

<p>[sourcecode language=&quot;groovy&quot;]</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">void testSingleColumnGetAndSet() {
    k[&amp;quot;User/a/user_id&amp;quot;] = &amp;quot;1&amp;quot;;
    assert k[&amp;quot;User/a/user_id&amp;quot;] == &amp;quot;1&amp;quot;;
}

void testSlice() {
    k[&amp;quot;User/b/1&amp;quot;] = &amp;quot;1&amp;quot;;
    k[&amp;quot;User/b/2&amp;quot;] = &amp;quot;2&amp;quot;;
    k[&amp;quot;User/b/3&amp;quot;] = &amp;quot;3&amp;quot;;

    assert k[&amp;quot;User/b/[1,2,3]&amp;quot;] == [b:[&amp;quot;1&amp;quot;, &amp;quot;2&amp;quot;, &amp;quot;3&amp;quot;]];
    assert k[&amp;quot;User/b/[1-2]&amp;quot;] == [b:[&amp;quot;1&amp;quot;, &amp;quot;2&amp;quot;]];
    assert k[&amp;quot;User/b/[3]&amp;quot;] == [b:[&amp;quot;3&amp;quot;]];
}

void testRangeSlices() {
    k[&amp;quot;User/d/1&amp;quot;] = &amp;quot;1&amp;quot;;
    k[&amp;quot;User/d/2&amp;quot;] = &amp;quot;2&amp;quot;;

    k[&amp;quot;User/e/1&amp;quot;] = &amp;quot;1&amp;quot;;
    k[&amp;quot;User/e/2&amp;quot;] = &amp;quot;2&amp;quot;;

    assert k[&amp;quot;User/[e-e]/[1,2,3]&amp;quot;] == [e:[&amp;quot;1&amp;quot;,&amp;quot;2&amp;quot;]];
    assert k[&amp;quot;User/[d-e]/[1,2,3]&amp;quot;] == [d:[&amp;quot;1&amp;quot;,&amp;quot;2&amp;quot;],e:[&amp;quot;1&amp;quot;,&amp;quot;2&amp;quot;]];
}
</code></pre></div><div class="highlight"><pre><code class="language-text" data-lang="text">object &#39;k&#39; is the keyspace wrapper, &#39;User&#39; the column family and keys and columns follow them in a &#39;/&#39; separated path.

Cassandra data model is simple with only complication of a SuperColumn as explained in the [blog][6] (the title of the post should give you an idea). 

  1. Keyspace: like a database schema
  2. ColumnFamily: Individual data spaces (User,Tweets)
  3. Key: A key in the ColumnFamily
  4. Column: A name,value and timestamp combination
  5. SuperColumn: A Column that can contain multiple columns (in a ColumnFamily you cannot mix super and &#39;normal&#39; columns)
Following diagram tries to explain the data model. 


    ![Cassandra DataModel][7]

Now lets have a look at the Groovy code that accesses Cassandra.

**How it works:**

This is simply achieved by providing getAt and putAt in the Keyspace object which is the Groovy way of operator overriding.

[sourcecode language=&quot;groovy&quot;] def getAt(String key) { def ctx = Selector.readContext(key) ctx[&quot;ks&quot;] = ks; def ret = client.get( ctx); return ret }


    void putAt(String key, Object value) {
        def ctx = Selector.writeContext(key)
        ctx[&amp;quot;ks&amp;quot;] = ks;
        client.put( ctx, value.toString());
    }
</code></pre></div>
<p>The &#39;selectors&#39; (keys used in the subscript operator) are inspired from <a href="http://commons.apache.org/jxpath/" title="JXPath">JXPath</a> world and are used for simple range queries as well. Below is a sample of the type of selectors that could be used.</p>

<p>[sourcecode language=&quot;groovy&quot;] void testIdentifySetRequest() { assert Selector.parse(&quot;cf/key/col&quot;, SelectorType.SET) == &quot;set<em>slice</em>col&quot;; }</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">void testIdentifyGetRequest() {
    assert Selector.parse(&amp;quot;cf/key/col&amp;quot;, SelectorType.GET) == &amp;quot;get_col&amp;quot;;

    assert Selector.parse(&amp;quot;cf/key/[col1,col2]&amp;quot;, SelectorType.GET) == &amp;quot;get_slice_col&amp;quot;; // key slice
    assert Selector.parse(&amp;quot;cf/key/[col1-col2]&amp;quot;, SelectorType.GET) == &amp;quot;get_slice_col&amp;quot;;   // col range
    assert Selector.parse(&amp;quot;cf/key/[col1-]&amp;quot;, SelectorType.GET) == &amp;quot;get_slice_col&amp;quot;; // start to end
    assert Selector.parse(&amp;quot;cf/key/[*]&amp;quot;, SelectorType.GET) ==  &amp;quot;get_slice_col&amp;quot;; // all cols

    assert Selector.parse(&amp;quot;cf/[key1-key2]/[col1-col2]&amp;quot;,SelectorType.GET) == &amp;quot;get_range_slice&amp;quot;; // range
}
</code></pre></div><div class="highlight"><pre><code class="language-text" data-lang="text">Selectors are implemented using regular expressions. Selectors parse the &#39;path&#39; expression and provide it as an input to client. Following is a code snippet of the expressions used.

[sourcecode language=&quot;groovy&quot;] def static final SET_REGEX = [ set_slice_col: ~/(\w+)\/(\w+)\/(\w+)/ ];


    def static final GET_REGEX = [
        get_col: ~/(\w+)\/(\w+)\/(\w+)/, //  column get
        get_slice_col: ~/(\w+)\/(\w+)\/((\[(\w+[,-]?)+\])|(\[\*\]))/, // give me all columns
        get_range_slice: ~ /(\w+)\/((\[(\w+[,-]?)+\])|(\[\*\]))\/((\[(\w+[,-]?)+\])|(\[\*\]))/,   // get range slice
        get_range_key: ~/(\w+)\/\[(\w+[,-]?)+\]/  // give me a key range
    ] as LinkedHashMap;
</code></pre></div>
<p>Below is the client code (GHector?) and Category code that takes out the reusable Cassandra specific code.</p>

<p>[sourcecode language=&quot;groovy&quot;] def put(ctx,value) { execute { Cassandra.Client client -&gt; use (CassandraCategory) { client.insert ctx.ks, ctx.key, cpath(ctx), value.serialize(), timestamp, defConLevel } } }</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">def execute(cmd) {
    TTransport tt = new TSocket(server, port);
    TProtocol tp =  new TBinaryProtocol(tt);
    Cassandra.Client c = new Cassandra.Client(tp);
    try {
        tt.open();
        cmd(c);
    } finally {
        tt.close();
    }
}
...
}
// Category code
class CassandraCategory {

static cpath(ks, args) {
    ColumnPath cp = new ColumnPath(args[&amp;quot;cf&amp;quot;]);
    cp.setColumn(args[&amp;quot;col&amp;quot;].bytes);
    return cp;
}

static serialize(String s) {
    return s.getBytes(&amp;quot;UTF-8&amp;quot;);
}
...
}
</code></pre></div><div class="highlight"><pre><code class="language-text" data-lang="text">This approach could be useful for applications where we have fixed queries so the selectors could be cached. An application selecting large number of columns/keys dynamically would need an alternate approach (some sort of query API with filters).

This is still a work in progress (like results could have column names as keys as well... wait a second , it looks like JSON). In future I will be trying to implement the client using Hector instead of the raw Thrift API. Your comments are appreciated on how to make this better.
</code></pre></div>

                <hr>

                <div id="disqus_thread"></div>
<script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'xebiaww'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

                <hr>

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2010/08/31/exploring-android-charting-and-graphs-solutions/" data-toggle="tooltip" data-placement="top" title="Exploring Android Charting And Graphs Solutions">&larr; Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2010/09/17/creating-and-styling-resizable-buttons/" data-toggle="tooltip" data-placement="top" title="Creating And Styling Resizable Buttons">Next Post &rarr;</a>
                    </li>
                    
                </ul>

            </div>
        </div>
    </div>
</article>

<hr>


    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="https://twitter.com/XebiaIndia">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://www.facebook.com/XebiaIndia">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://github.com/xebiaww">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
                <p class="copyright text-muted">Copyright &copy; Xebia Blog 2015</p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/clean-blog.min.js "></script>


</body>

</html>
