<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Thoughts on latest technologies">

    <title>Processing Custom Annotations - Xebia Blog</title>

    <link rel="canonical" href="http://xebia.com/2010/08/09/processing-custom-annotations/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Xebia Blog</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    <!-- Post Header -->
<header class="intro-header" style="background-image: url('/img/default-blog-pic.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>Processing Custom Annotations</h1>
                    
                    <span class="meta">Posted by jdhingra on August 9, 2010</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">

				<h1>Processing Custom Annotations</h1>

<p><strong>How to write custom annotations using APT?</strong>   </p>

<p>Annotations provide data about a program that is not part of the program itself. The more advanced uses of annotations include writing an annotation processor that can read a Java program and take actions based on its annotations. To facilitate this task, release 5.0 of the JDK includes an annotation processing tool, called apt. In release 6 of the JDK, the functionality of apt is a standard part of the Java compiler. </p>

<p><strong>Using APT-Annotation Processing Tool</strong></p>

<ol>
<li>JDK tool for processing source annotations</li>
<li>cleaner model of source and types than doclet</li>
<li>support recursive processing of generated files</li>
<li>Multiple processors (vs single doclet)</li>
</ol>

<p>Each processor implements the <em>AnnotationProcessor</em> interface in the package com.sun.mirror.apt. This interface has one method i.e. process used by the apt tool to invoke the processor. A processor will &quot;process&quot; one or more annotation types. A processor instance is returned by its corresponding factory - an <em>AnnotationProcessorFactory</em>. The apt tool calls the factory&#39;s <em>getProcessorFor</em> method to get hold of the processor. During this call, the tool provides an <em>AnnotationProcessorEnvironment</em>. In the environment the processor will find everything it needs to get started, including references to the program structure on which it is operating, and the means to communicate and cooperate with the apt tool by creating new files and passing on warning and error messages.</p>

<p><strong>Steps for creating a custom processor</strong></p>

<ol>
<li>Write an annotation processor, extends <em>AbstractProcessor</em>

<ul>
<li>Provide implementation for _process _method-public void process();</li>
<li>Implement the annotation processing logic</li>
<li>Use environment from <em>AnnotationProcessorFactory</em>; iterate through types being processed</li>
</ul></li>
<li>add tools.jar to classpath</li>
<li>Invoke apt</li>
<li><p>Use Mirror packages for representing types and processing declaration and types.
<strong>APT Configuration</strong></p></li>
<li><p>Configuration is done by creating text file containing fully qualified name of the AP under file META-INF/services/javax.annotation.processing.Processor. Sample file content is shown below: [sourcecode language=&quot;java&quot;]com.abc.ConstructorWithoutArgsProcessor[/sourcecode]</p></li>
<li><p>Jar the AP classes and META-INF
[sourcecode language=&quot;java&quot;] jar cvMif myProcessor.jar -C com/_ META-INF/services/_ [/sourcecode]  <strong>Sample Annotation Processor Source Code</strong></p></li>
</ol>

<p>[sourcecode language=&quot;java&quot;] public class MyCustomProcessor extends AbstractProcessor { public boolean process(Set annotations, RoundEnvironment env) { for (TypeElement type : annotations) { doProcess(env, type); } return true; } [/sourcecode] Let&#39;s write a sample annotation [sourcecode language=&quot;java&quot;] @Inherited @Documented @Retention(RetentionPolicy.SOURCE) @Target(ElementType.TYPE) public @interface ConstructorWithoutArgs { } [/sourcecode] Here is the code of custom processor: [sourcecode language=&quot;java&quot;] @SupportedAnnotationTypes(&quot;com.abc.ConstructorWithoutArgs&quot;) @SupportedSourceVersion(SourceVersion.RELEASE_6) public class ConstructorWithoutArgsProcessor extends AbstractProcessor { public boolean process(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment env) { for (TypeElement type : annotations) { processClassesWithoutConstructorArgs(env, type); } return true; }</p>

<p>private void processClassesWithoutConstructorArgs(RoundEnvironment env, TypeElement type) { for (Element element : env.getElementsAnnotatedWith(type)) { processClass(element); } }</p>

<p>private void processClass(Element element) { if (!doesClassContainConstructorWithoutArgs(element)) { processingEnv.getMessager().printMessage(Diagnostic.Kind.ERROR, &quot;Class &quot; + element + &quot; needs a No-Args Constructor&quot;); } }</p>

<p>private boolean doesClassContainConstructorWithoutArgs(Element el) { for (Element subelement : el.getEnclosedElements()) { if (subelement.getKind() == ElementKind.CONSTRUCTOR &amp;&amp; subelement.getModifiers().contains(Modifier.PUBLIC)) { TypeMirror mirror = subelement.asType(); if (mirror.accept(noArgsVisitor, null)) return true; } } return false; }</p>

<p>private static final TypeVisitor<Boolean, Void> noArgsVisitor = new SimpleTypeVisitor6<Boolean, Void>() { public Boolean visitExecutable(ExecutableType t, Void v) { return t.getParameterTypes().isEmpty(); } }; } [/sourcecode] In the doesClassContainConstructorWithoutArgs() method, we iterate through all of the class elements and pick out the public constructors. A class that does not have any will automatically fail the test. Note that when we do not specify any constructor, Java automatically adds a default no-args constructor. </p>

<p>Once we have found our constructor element, we visit it with to determine whether the argument list is empty. Using the Visitor pattern in this case helps us to avoid a downcast. Once we have all these files packaged in a jar file, let&#39;s call it myProcessor.jar, we can add a processing parameter to our call to javac: [sourcecode language=&quot;java&quot;] javac -classpath .;myProcessor.jar -processorpath myProcessor.jar com/*.java [/sourcecode]</p>

<p>Let&#39;s test this with few test cases: [sourcecode language=&quot;java&quot;] @ConstructorWithoutArgs public abstract class SuperClassWithoutArgs { public SuperClassWithoutArgs() { } }</p>

<p>// Passes public class PublicConstructorWithoutArgs extends SuperClassWithoutArgs { public PublicConstructorWithoutArgs() { } }</p>

<p>// Fails public class NonPublicConstructor extends SuperClassWithoutArgs { NonPublicConstructor() { } }</p>

<p>// Fails public class WrongConstructor extends SuperClassWithoutArgs { public WrongConstructor(String aString) { } } [/sourcecode] When we compile these classes with the ConstructorWithoutArgsProcessor, we see the following compiler errors: </p>
<div class="highlight"><pre><code class="language-text" data-lang="text">error: Class NonPublicConstructor needs a No-Args Constructor
error: Class WrongConstructor needs a No-Args Constructor
2 errors
</code></pre></div>
<p><strong>Limitations of APT</strong></p>

<ol>
<li>no processing of local variable annotations</li>
<li>no inheritance of annotations
In this way, we can write custom annotations which may require specific logic for any certain business needs like persistence, auditing etc. In Java SE 6, annotations can be written only on method parameters and the declarations of packages, classes, methods, fields, and local variables. <a href="http://types.cs.washington.edu/jsr308/">JSR 308</a> extends Java to allow annotations on nearly any use of a type, and on type parameter declarations. JSR 308 uses a simple prefix syntax for type annotations, with a special case for receiver types and for constructor results. The <a href="http://types.cs.washington.edu/checker-framework/">Checker Framework</a> is one way to create plug-ins that do pluggable type-checking for the type qualifiers. A pluggable type-checker enables you to detect certain bugs in your code, or to prove that they are not present and this verification happens at compile time. The Checker Framework enhances Java’s type system to make it more powerful and useful. This lets software developers detect and prevent errors in their Java programs. </li>
</ol>


                <hr>

                <div id="disqus_thread"></div>
<script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'xebiaww'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

                <hr>

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2010/08/04/flex-exploiting-data-bindings-for-crud-based-applications/" data-toggle="tooltip" data-placement="top" title="Flex Exploiting Data Bindings For Crud Based Applications">&larr; Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2010/08/11/xml-communication-between-tapestry-and-flex/" data-toggle="tooltip" data-placement="top" title="Xml Communication Between Tapestry And Flex">Next Post &rarr;</a>
                    </li>
                    
                </ul>

            </div>
        </div>
    </div>
</article>

<hr>


    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="https://twitter.com/XebiaIndia">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://www.facebook.com/XebiaIndia">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://github.com/xebiaww">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
                <p class="copyright text-muted">Copyright &copy; Xebia Blog 2015</p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/clean-blog.min.js "></script>


</body>

</html>
