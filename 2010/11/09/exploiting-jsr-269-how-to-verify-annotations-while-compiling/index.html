<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Thoughts on latest technologies">

    <title>Exploiting Jsr 269 How To Verify Annotations While Compiling - Xebia Blog</title>

    <link rel="canonical" href="http://xebia.com/2010/11/09/exploiting-jsr-269-how-to-verify-annotations-while-compiling/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Xebia Blog</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    <!-- Post Header -->
<header class="intro-header" style="background-image: url('/img/default-blog-pic.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>Exploiting Jsr 269 How To Verify Annotations While Compiling</h1>
                    
                    <span class="meta">Posted by rsharma on November 9, 2010</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">

				<h1>Exploiting JSR 269 : How to Verify Annotations while Compiling</h1>

<h3>The Issue</h3>

<p>** <strong>Now-a-days every library that you use is <a href="http://download.oracle.com/javase/tutorial/java/javaOO/annotations.html">Annotations</a> based. Annotations offer a better readable approach over the traditional XML approach._</strong> But there is a problem while using annotations, you can not force a class to have some annotations in place.**_ You can say it with XMLs by creating some abstractions but you can not force the same with annotations, it is up to the developer to use the required annotations. This problem orignates from the way annotations are implemented in JDK.</p>

<p>Annotations are basically class/method specific. With Annotations you can at best say that if some class implements some base-class then it can have some annotation that was used in base-class( using the <em>@<a href="http://download.oracle.com/javase/6/docs/api/java/lang/annotation/Inherited.html">inherited</a></em><a href="http://download.oracle.com/javase/6/docs/api/java/lang/annotation/Inherited.html"> </a>meta-annotation)<img src="http://rash0208.wordpress.com/wp-includes/js/tinymce/plugins/wordpress/img/trans.gif" alt="" title="More..."></p>

<p>[sourcecode language=&quot;java&quot;] @Retention(RetentionPolicy.RUNTIME) @Inherited public @interface MyMarkerAnnotation {}</p>

<p>@MyMarkerAnnotation public class PlayWithAnnotation {}</p>

<p>class Playground extends PlayWithAnnotation{ // This class will contain MyMarkerAnnotation } [/sourcecode]</p>

<p>But you can not say sub classes of some-other-baseclass must have some-other-Annotation and the compiler must enforce it. There can be varried reasons why I require this, the  following are few of them : </p>

<ul>
<li>I can not use the some-other-Annotation in base-class as each sub-class must provide its own set of parameters for the some-other-Annotation.</li>
<li>OR  maybe the Annotation is a third-party annotation and thus I can not modify it to have @<a href="http://download.oracle.com/javase/6/docs/api/java/lang/annotation/Inherited.html">inherited </a>meta-annotation.
Keeping the same goal in mind i.e. some how enforce sub-class to must have an annotation, mandated by its super-class, my intention was to some how enable the JDK compiler to break the compilation process and report the required errors.</li>
</ul>

<p>[sourcecode language=&quot;java&quot;] @Retention(RetentionPolicy.RUNTIME) public @interface SecondMarkerAnnotation {}</p>

<p>public class SomeBaseClass { }</p>

<p>public class SomeOtherSubClass extends SomeBaseClass { } [/sourcecode]</p>

<p>[sourcecode language=&quot;text&quot;] Configuration : in.annotations.playground.SomebaseClass = in.annotations.SecondMarkerAnnotation</p>

<p>Compiler Output : error: in.annotations.playground.SomeOtherSubClass did not contain in.annotations.SecondMarkerAnnotation annotation [/sourcecode] </p>

<h3>First Try : Maven Plugin</h3>

<p>In order to accomplish this I have to perform the following steps: </p>

<ul>
<li>somehow scan the whole project,</li>
<li>find the sub-classes of the provided super-class,</li>
<li>check if the sub-class contains the same annotations and then</li>
<li>some how throw errors if it does not meet the requirements.</li>
<li>all of this should work while making a build
At first I thought a maven-plugin should be an apt choice for such a task and started building the same. With this approach finding the annotations and running with the build were the only easier parts and rest of the steps were pretty hard ones. After a while I found out that the approach of a maven-plugin is not an appropriate choice for such a task esp if you want to plug into the JDK compiler. </li>
</ul>

<h3>Second Try: Using Annotation Processing API(JSR 269)</h3>

<p>With the advent of JSR 269 i.e. the Annotation Processing API/tool in the JDK compiler you can already pretty much get into the JDK compilation process. But this is something that you can do with <strong>JDK 6 ONLY</strong>. So I started using the <a href="http://download.oracle.com/javase/6/docs/api/javax/annotation/processing/AbstractProcessor.html">AbstractProcesser </a>API provided and created my custom processor that can do the same. For each of the steps that was required there is support from the API itself : </p>

<p>Steps Required
Support Offered</p>

<p>Scan the whole project
The JDK itself scans the whole project and with the use of @<a href="http://download.oracle.com/javase/6/docs/api/javax/annotation/processing/SupportedAnnotationTypes.html">SupportedAnnotationTypes</a>(&quot;*&quot;) the Annotation Processor API can give you every class in the project that is complied.</p>

<p>Find the required sub-classes
Seems like a simple Reflection stuff but the API does not offer simple class objects with which you can work instead you have implement the <a href="http://download.oracle.com/javase/6/docs/api/javax/lang/model/element/ElementVisitor.html">ElementVisitor </a>Api for the same.</p>

<p>Check if the class contains the same annotations
Once you are in the <a href="http://download.oracle.com/javase/6/docs/api/javax/lang/model/element/ElementVisitor.html">ElementVisitor </a>API this is simple Reflection stuff. You can check the annotations of the class.</p>

<p>Throw errors if it does not meet the requirements
Here again the Annotation Processor API offers the <a href="http://download.oracle.com/javase/6/docs/api/javax/annotation/processing/Messager.html">Messager </a>API that can be used to report errors or other info. The errors when reported will break the build process.</p>

<p>Process while making a build
With Apt tool you can run the required the Annotation Processors manually with the java compiler. But if you package the Jar file correctly i.e. having a javax.annotation.processing.Processor file in META-INF/services folder then the compiler would automatically invoke it every time.
The only thing that is required is that you need to pass some configuration to the implemented AnnoationProcesser. Here also the API provides full support, you can pass arguments required for Annotation processing using the -A options with the compiler e.g.    javac -AannotationOption1=value1 -Aannotationoption2=value2.  Also you will be required to put  @<a href="http://download.oracle.com/javase/6/docs/api/javax/annotation/processing/SupportedOptions.html">SupportedOptions</a>(value = { &quot;annoationOption1&quot;,&quot;annotationOption2&quot;})  on your Processor else you may get a message that the options are not required by any processors.</p>

<p>Using the above mentioned APIs I created AnnotationVerifier and made a jar file that can be added to the classpath. You have to pass a mapping to the AnnotationVerifier that can specify which class file will map to which annotations. The compiler would call the verifier, that would assert if the sub-classes contain the required annotations.</p>

<p>[sourcecode language=&quot;java&quot;] @SupportedAnnotationTypes(&quot;*&quot;) @SupportedSourceVersion(SourceVersion.RELEASE_6) @SupportedOptions(value = { &quot;AnnotationVerifier.Annotations&quot;, &quot;AnnotationVerifier.Baseclasses&quot;, &quot;AnnotationVerifier.ClassAnnotation.Mappings&quot; }) public class AnnotationVerifier extends AbstractProcessor { MessagerWrapper customMessager = new MessagerWrapper();</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">@Override
public boolean process(Set&amp;lt;? extends TypeElement&amp;gt; annotations,
        RoundEnvironment roundEnv) {
    if (!roundEnv.processingOver()) {
        ConfigurationLoader configurationLoader = new AptOptionsConfigurationLoader(
                customMessager, processingEnv.getOptions());
        List&amp;lt;AnnotationBaseclassMapper&amp;gt; processOptions = configurationLoader
                .loadConfiguration();
</code></pre></div>

                <hr>

                <div id="disqus_thread"></div>
<script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'xebiaww'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

                <hr>

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2010/11/03/agile-testing-incremental-functional-test-approach/" data-toggle="tooltip" data-placement="top" title="Agile Testing Incremental Functional Test Approach">&larr; Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2010/11/09/life-in-a-corporate-5-importance-of-professional-character/" data-toggle="tooltip" data-placement="top" title="Life In A Corporate 5 Importance Of Professional Character">Next Post &rarr;</a>
                    </li>
                    
                </ul>

            </div>
        </div>
    </div>
</article>

<hr>


    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="https://twitter.com/XebiaIndia">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://www.facebook.com/XebiaIndia">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://github.com/xebiaww">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
                <p class="copyright text-muted">Copyright &copy; Xebia Blog 2015</p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/clean-blog.min.js "></script>


</body>

</html>
