<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Thoughts on latest technologies">

    <title>Using Annotations To Inject Metadata Driven Aop - Xebia Blog</title>

    <link rel="canonical" href="http://blog.xebia.in/2011/02/16/using-annotations-to-inject-metadata-driven-aop/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Xebia Blog</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="http://xebia.com/" target="_blank">Xebia</a>
                </li>
                <li>
                    <a href="/">Home</a>
                </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    <!-- Post Header -->
<header class="intro-header" style="background-image: url('/img/default-blog-pic.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>Using Annotations To Inject Metadata Driven Aop</h1>
                    
                    <span class="meta">Posted by rgarg on February 16, 2011</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">

        <div class="row">
          <!-- Go to www.addthis.com/dashboard to customize your tools -->
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=shekhargulati" async="async"></script>

            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
              <h4>Reading time about 4  minutes</h4>

              <h1>Using Annotations To Inject - Metadata Driven AOP</h1>

<p>New releases of compilers are getting more and more cautious on taking off the pain of too much verbosity and making the code look much more cleaner, understandable and easily modifiable. A major step that has been taken in Java side is introduction of annotations. Now that they have introduced annotations, plugging in an annotation processor still seems like an unsolved job requiring changes of the level of JVM startup arguments.<br>
<strong><em>Issues with existing APT (Annotation Processing Tool) :</em></strong></p>

<ul>
<li>The existing API involves changes to the JVM arguments in case some change is required.</li>
<li>Changes at runtime will not be possible as once a annotation processor is started, it will add the processing instructions. You cannot change this behavior in an already running application.
I was reading through one article that involved AOP and looked at one of the sample snippets that described about instrumenting Transactional attributes, so called boiler plate code for handling transactions into the services. The text clearly mentioned that it is possible or rather very easy to add metadata based advising into the code. After reading that line, I actually thought that it can be a possibility that the metadata processor or so called <a href="http://static.springsource.org/spring/docs/2.0.x/api/org/springframework/aop/Pointcut.html">Pointcut</a> can be built based on annotation processing and the <a href="http://aopalliance.sourceforge.net/doc/org/aopalliance/aop/Advice.html">Advice</a> implementation can contain the code that you need to instrument or simply hide from your code because you think it is boiler plate.</li>
</ul>

<p>By implementing this mechanism, you just change your application context file and thus avoid the headache of changing the startup arguments. Also you can <a href="http://xebee.xebia.in/2010/12/08/spring-altering-your-applicationcontext-at-runtime/">configure your context</a> prior to starting in case you don&#39;t want your annotations to become active.<br>
<strong><em>The code part :</em></strong> Usually its the most tricky part but in our case, this seems the least complex. There is one class named <a href="http://static.springsource.org/spring/docs/2.0.x/api/org/springframework/aop/framework/autoproxy/DefaultAdvisorAutoProxyCreator.html">DefaultAdvisorAutoProxyCreator</a> which needs to be added to the usual <strong>applicationContext.xml</strong> file. You also need to create your own <a href="http://download.oracle.com/javase/1.5.0/docs/guide/language/annotations.html">Annotation</a> and define its settings. Last but not the least, you need a <a href="http://static.springsource.org/spring/docs/2.0.x/api/org/springframework/aop/PointcutAdvisor.html">PointcutAdvisor</a> which will tell spring about which classes to process and what should be the processing.</p>

<p>In the sample code below, I would be adding a <strong>SpookyAnnotation</strong> on top of a bean and will allow the <strong>SpookyingInterceptor</strong> to create a proxy of the bean with the injected code. The <em>SpookyingInterceptor</em> does nothing but adds the advice of a <em>System.out.println</em> statement in the methods of the bean which has this annotation present.</p>

<p><em>applicationContext.xml</em> [code language=&quot;xml&quot;] <bean:bean class="org.springframework.aop.framework.autoproxy.DefaultAdvisorAutoProxyCreator" /> <bean:bean class="test.beans.interceptor.SpookyingInterceptor" /></pre> 
 ```</p>

<p><em>Annotation</em> <code>
 @Retention(value= RetentionPolicy.RUNTIME) public @interface SpookyAnnotation { boolean insertSpookiness() default true; } 
</code></p>

<p><em>Interceptor class</em> ``` 
 package test.beans.interceptor;</p>

<p>import .... import test.annotations.SpookyAnnotation; public class SpookyingInterceptor extends AbstractPointcutAdvisor{</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">public Pointcut getPointcut() {
    return new Pointcut() {
        public MethodMatcher getMethodMatcher() {
            return new MethodMatcher() {
                public boolean matches(Method arg0, Class&amp;lt;?&amp;gt; arg1, Object[] arg2) {
                    .....
                }
                public boolean matches(Method arg0, Class&amp;lt;?&amp;gt; arg1) {
                    .....
                }
                public boolean isRuntime() {
                    .....
                }
            };
        }

        public ClassFilter getClassFilter() {
            return new ClassFilter() {
                public boolean matches(Class&amp;lt;?&amp;gt; clazz) {
                    if(clazz.getAnnotation(SpookyAnnotation.class) == null) {
                        return false;
                    } else {
                        return clazz.getAnnotation(SpookyAnnotation.class)
                            .insertSpookiness();
                    }
                }
            };
        }
    };
}

public Advice getAdvice() {
    return new MethodBeforeAdvice() {
        public void before(Method method, Object[] methodArgs, Object objOfClazz)
                throws Throwable {
            System.out.println(&amp;quot;The method &amp;quot; + method.getName() 
                                    + &amp;quot; has been spooked!!&amp;quot;);
        }
    };
}
</code></pre></div>
<p>} 
 ```</p>

<p><em>Bean/Service classes</em> <code>
 package test.beans; import test.annotations.SpookyAnnotation; @SpookyAnnotation(insertSpookiness = false) public class BeanWithNonSpookyCode { public void callMe() { System.out.println(&quot;non spooky one has been called&quot;); } } 
</code></p>
<div class="highlight"><pre><code class="language-text" data-lang="text"> package test.beans; public class AnotherBeanWithNonSpookyCode { public void callMe() { System.out.println(&quot;non spooky one has been called&quot;); } } 
</code></pre></div><div class="highlight"><pre><code class="language-text" data-lang="text"> package test.beans; import test.annotations.SpookyAnnotation; @SpookyAnnotation public class BeanWithSpookyCode { public void callMe() { System.out.println(&quot;spooky one has been called&quot;); } } 
</code></pre></div>
<p><em>Bean definitions</em> [code language=&quot;xml&quot;] <bean:bean id="beanWithNonSpooky" class="test.beans.BeanWithNonSpookyCode" /> <bean:bean id="anotherBeanWithNonSpooky" class="test.beans.AnotherBeanWithNonSpookyCode" /> <bean:bean id="beanWithSpooky" class="test.beans.BeanWithSpookyCode" /> 
 ```</p>

<p><a href="http://static.springsource.org/spring/docs/2.0.x/api/org/springframework/aop/MethodBeforeAdvice.html">MethodBeforeAdvice</a> is a standard class which instruments the code in before method before the method call.   </p>

<p><strong><em>Conclusion :</em></strong></p>

<ul>
<li>This style of coding is very highly plug and play because removing the <strong>PointcutAdvisor</strong> bean from <strong>applicationContext.xml</strong> will stop annotation processing for this particular annotation and you just need to add annotation to the class which you need to apply the <strong>Advice</strong> to. Rest of the code would remain untouched.</li>
<li>You might feel some startup delay with this code because initializing this structure and instrumenting code surely needs some time, but execution time remains unaffected.</li>
<li>You need <strong>CGLIB</strong> in your class-path for using <a href="http://static.springsource.org/spring/docs/2.0.1/reference/aop-api.html">AOP</a>. Rest is normal spring dependencies that are added to the project. </li>
<li>Java version should at-least be <strong>1.5</strong> because annotations are not supported below that.</li>
</ul>

<p><strong>~~~Happy Annotating~~~</strong></p>


                <hr>

                <div id="disqus_thread"></div>
<script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'xebiaww'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

                <hr>

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2011/02/10/love-spring-web-mvc/" data-toggle="tooltip" data-placement="top" title="Love Spring Web Mvc">&larr; Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2011/02/18/has-agile-become-another-waterfall/" data-toggle="tooltip" data-placement="top" title="Has Agile Become Another Waterfall">Next Post &rarr;</a>
                    </li>
                    
                </ul>

            </div>
        </div>
    </div>
</article>

<hr>


    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="https://twitter.com/XebiaIndia">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://www.facebook.com/XebiaIndia">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://github.com/xebiaww">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
                <p class="copyright text-muted">Copyright &copy; <a href="http://xebia.com/" target="_blank">Xebia</a> 2015</p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/clean-blog.min.js "></script>

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-58958750-1', 'auto');
  ga('send', 'pageview');

</script>
</body>

</html>
