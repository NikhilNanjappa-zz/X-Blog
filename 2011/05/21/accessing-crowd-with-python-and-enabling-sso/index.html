<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Thoughts on latest technologies">

    <title>Accessing Crowd With Python And Enabling Sso - Xebia Blog</title>

    <link rel="canonical" href="http://blog.xebia.in/2011/05/21/accessing-crowd-with-python-and-enabling-sso/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Xebia Blog</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    <!-- Post Header -->
<header class="intro-header" style="background-image: url('/img/default-blog-pic.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>Accessing Crowd With Python And Enabling Sso</h1>
                    
                    <span class="meta">Posted by gkohli on May 21, 2011</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">

        <div class="row">
          <!-- Go to www.addthis.com/dashboard to customize your tools -->
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=shekhargulati" async="async"></script>

            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
              <h4>Reading time about 6  minutes</h4>

              <h1>Accessing Crowd with Python and enabling SSO</h1>

<p>What we are trying to have here is a python client which can talk to Crowd and be part of the Crowd SSO (Single sign-on)  along with other applications written in Java/.NET<a href="http://confluence.atlassian.com/display/CROWDDEV/Java+Integration+Libraries" title="Java Integration Libraries">1</a>. This is possible because of the SOAP &amp; REST API&#39;s which the Crowd exposes. In our organization we are still using Crowd 2.0.6, so I would be explaining only about how to use SOAP API&#39;s and not the REST API&#39;s.</p>

<p>Crowd is a application from Atlassian world which provides you a framework for single sign-on and centralized authentication. And underneath it can connect to a lot of User Directories like LDAP, Microsoft Active Directory, SUN and Fedora Directories and many more. So for all your enterprise applications, you can use Crowd to manage all the User details, and it greatly simplifies the thing as now there is just one location where all the information is stored.</p>

<p>The Crowd&#39;s SSO capabilities enables you to log into one website and move between your other web applications without having to log in repeatedly. This provides a lot better User interaction and since all the applications are internal to one organization, it also doesn&#39;t make sense for each user to sign into each one of them again and again, even though he is using a same browser.</p>

<p>Now most of the SSO implementations are based on the concept of storing some HTTP cookies, since you need some way to acknowledge who is coming to your website and same is with Crowd Server. Usually everyone stores some authentication token in cookies which each application can use and have it validated by the main SSO server. Now the only problem with HTTP cookies is that only the application of same domain can have access to it. So now there could be two possibilities, either our python client is in the same domain as Crowd, in which case we can use the Crowd domain information or we are in some other domain and we will have to explicitly set our own cookie.</p>

<p>Let&#39;s get into some code now.</p>

<p>The code is written in python, but it is pretty simple SOAP usage, so you could  write the same thing in any language, you only need some basic SOAP understanding .</p>

<p>We start with installing the crowd server first. Once we have the crowd server, we can access the SOAP wsdl at http://localhost:8095/crowd/services/SecurityServer?wsdl [2]. The WSDL can help you understand all the functions which you can call on the Crowd Server. I have currently used just 4 functions: authenticateApplication, authenticatePrincipal, isValidPrincipalToken and getCookieInfo. For integration with Crowd application server, we first need to create a application from within Crowd server and specify the name, password and the ip address from where we would be using the application. This is just the snippets and full code is uploaded on github[3]</p>

<p>We use Python Suds module for talking to the Crowd SOAP endpoint. We create a soap client using &quot;Client(self.wsdlurl,doctor=doctor)&quot;  and we pass in the url for the Soap Wsdl. The second parameter which you see is the Suds way to clean the wsdl xml. The Crowd wsdl has some namespace problems for which we create a ImportDoctor which fixes the missing namespace for few of the elements in WSDL.</p>

<p>[sourcecode lang=&quot;python&quot;] class CrowdPy: def <strong>init</strong>(self): cfg = ConfigParser() cfg.read(&#39;crowd.properties&#39;) self.appname = cfg.get(&#39;default&#39;,&#39;application.name&#39;) #.... Read all the properties from the Configuration File</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">    #Use Pythin Suds module to create a SOAP client
def createClient(self):
            # The Crowd Wsdl has some problems in namespace, so we need to patch thoes
    patches = { &amp;quot;urn:SecurityServer&amp;quot;: [&amp;quot;http://authentication.integration.crowd.atlassian.com&amp;quot;}
    doctor = dr.ImportDoctor()

    # Patch all the imports into the proper targetNamespaces
    for targetNamespace in patches:
        for nsimport in patches[targetNamespace]:
        imp = dr.Import(nsimport)
        imp.filter.add(targetNamespace)
        doctor.add(imp)
            # Creating the Suds Client
    self.client = Client(self.wsdlurl,doctor=doctor)
    return self.client
</code></pre></div><div class="highlight"><pre><code class="language-text" data-lang="text">Using the client we have to authenticate the application using the application name and the password specified when a new application was added in Crowd. The Crowd internally uses this information along with the ip address from where the request is coming to validate the application and then returns a application authentication token which we would use further on to authenticate Principal (User)

[sourcecode lang=&quot;python&quot;] def authenticateApplication(self): auth_context = self.client.factory.create(&#39;ns1:ApplicationAuthenticationContext&#39;) auth_context.name = &#39;application name specified in crowd&#39; auth_context.credential.credential = &#39;application password specified in crowd&#39; self.token = self.client.service.authenticateApplication(auth_context) return self.token
</code></pre></div>
<p>Now we call the authenticatePrincipal function to authenticate the User using the application authentication token and the user credentials. This would return a user authentication token which we can save in the cookies. This is perfectly save, as this is valid only if used along with the application authentication token and also from the same machine ip address.</p>

<p>[sourcecode lang=&quot;python&quot;] def authenticatePrincipal(self,username,passwd): user<em>context = self.client.factory.create(&#39;ns1:UserAuthenticationContext&#39;) user</em>context.application = &#39;application name specified in crowd&#39; user<em>context.name = username user</em>context.credential.credential = passwd self.user<em>token = self.client.service.authenticatePrincipal(self.token,user</em>context) return self.user_token 
```</p>

<p>So at this moment we have the user authenticated by Crowd, but where is the SSO ? For having the SSO feature, we have to do two things before even asking for username/password from user, first whenever we need the user authentication we need to check if the user was already authenticated by some other application. For doing that we have to check for cookies with key &quot;cookie.token_key&quot; and the value of the this key is the user authentication token saved by some other application. I would be telling how to validate this token in a minute. In case we don&#39;t have such a cookie in browser, we then ask username/password and call the function authenticatePrincipal specified above and then save the user token back into a new cookie.</p>

<p>And here is the code to validate the cookie in case it was already there in the browser. We have to use the user authentication token from the cookie and the application token and along with that we pass the Validataion Factors, which should have the correct IP address where the proxy application is running. In my case both the proxy and the Crowd server were on the same machine, so I have used &quot;127.0.0.1&quot;</p>

<p>[sourcecode lang=&quot;python&quot;] def isValidPrincipalToken(self,user<em>token): vf1 = self.client.factory.create(&#39;ns1:ValidationFactor&#39;) vf1.name = &#39;remote</em>host&#39; vf1.value = &#39;127.0.0.1&#39; vf = [vf1] isValid = self.client.service.isValidPrincipalToken(self.token,user_token,vf) return isValid 
```</p>

<p>So in this way either the application uses the cookie saved by some other application in the browser and have it validated by the Crowd server, or ask the user for username/password and have it authenticated from Crowd and creates a new cookie in the browser for all the other applications within the same SSO group to use. You just have to make sure the domain name in the cookie is same for all the applications.</p>

<ol>
<li><a href="http://confluence.atlassian.com/display/CROWDDEV/Java+Integration+Libraries" title="Java Integration Libraries">Java Integration Libraries</a></li>
</ol>


                <hr>

                <div id="disqus_thread"></div>
<script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'xebiaww'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

                <hr>

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2011/05/15/analysing-git-branching-model-with-kanban/" data-toggle="tooltip" data-placement="top" title="Analysing Git Branching Model With Kanban">&larr; Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2011/06/10/jboss-drools-performance-and-memory-internals/" data-toggle="tooltip" data-placement="top" title="Jboss Drools Performance And Memory Internals">Next Post &rarr;</a>
                    </li>
                    
                </ul>

            </div>
        </div>
    </div>
</article>

<hr>


    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="https://twitter.com/XebiaIndia">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://www.facebook.com/XebiaIndia">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://github.com/xebiaww">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
                <p class="copyright text-muted">Copyright &copy; Xebia Blog 2015</p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/clean-blog.min.js "></script>


</body>

</html>
