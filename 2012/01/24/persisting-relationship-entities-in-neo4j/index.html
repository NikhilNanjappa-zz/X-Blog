<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Thoughts on latest technologies">

    <title>Persisting Relationship Entities In Neo4j - Xebia Blog</title>

    <link rel="canonical" href="http://blog.xebia.in/2012/01/24/persisting-relationship-entities-in-neo4j/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Xebia Blog</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    <!-- Post Header -->
<header class="intro-header" style="background-image: url('/img/default-blog-pic.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>Persisting Relationship Entities In Neo4j</h1>
                    
                    <span class="meta">Posted by sunil.inteti on January 24, 2012</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">

        <div class="row">
          <!-- Go to www.addthis.com/dashboard to customize your tools -->
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=shekhargulati" async="async"></script>

            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
              <h4>Reading time about 3  minutes</h4>

              <h1>Persisting relationship entities in Neo4j</h1>

<p><a href="http://neo4j.org/">Neo4j</a> is a high-performance, NOSQL graph database with all the features of a mature and robust database. In Neo4j data gets stored in nodes connected to each other by relationship entities that carry its own properties. These relationships are very important in graphs and helps to traverse the graph and make decisions. This blog discusses the two ways to persist a relationship between nodes and also the scenario&#39;s which suits their respective usage. <a href="http://neo4j.org/spring/">Spring-data-neo4j</a> by springsource gives us the flexibility of using the spring programming model when working with neo4j database. The code examples in this blog will be using spring-data-neo4j.  Let&#39;s consider a case where we have two NodeEntities Employee and Project. A Employee has a role in a project which is a relationship entity. Here is the code snippet for these entities and the relationship between them. [sourcecode lang=&quot;java&quot;] @NodeEntity public class Employee { @GraphId @Indexed private Long nodeId;</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">@Indexed
private String name;

@RelatedToVia(elementClass = Role.class, type=&amp;quot;WORKED_IN&amp;quot;, direction=Direction.BOTH)
private Set&amp;lt;Role&amp;gt; roles;
</code></pre></div>
<p>}</p>

<p>@NodeEntity public class Project {</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">@GraphId
@Indexed
private Long nodeId;

@Indexed
private String name;

@RelatedTo( elementClass=Employee.class, type=&amp;quot;WORKED_IN&amp;quot;, direction=Direction.BOTH)
private Set&amp;lt;Employee&amp;gt; teamMembers;
</code></pre></div>
<p>}</p>

<p>@RelationshipEntity(type=&quot;WORKED_IN&quot;) public class Role {</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">@GraphId
private Long nodeId;

@Indexed
private String name;

@StartNode
private Employee employee;

@EndNode
private Project project;
</code></pre></div>
<p>} 
<code>1) First way to persist relationship : Using the Neo4jTemplate class to create relationship. For example [sourcecode lang=&quot;java&quot;] Role stint = template.createRelationshipBetween(sunil, beachbody, Role.class, &quot;WORKED_IN&quot;, false); template.save(stint); 
</code> createRelationship method takes the two node entities and the relationship class and relation type defined by the RelationshipEntity and a boolean value to allow/disallow duplicate relationships.</p>

<p>2) Second way is to instantiate the role and add it to a employee entity and persist the employee entity. Persisting the entity also persists the Role entity too, thus establishing the link between employee and project nodes. [sourcecode lang=&quot;java&quot;] Employee sunil = new Employee(&quot;Sunil&quot;); sunil = employeeRepo.save(sunil); Project beachbody = new Project(&quot;Beachbody&quot;); Project project = projectRepo.save(beachbody);</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">    Role stint = sunil.workedIn(beachbody, &amp;quot;Java developer&amp;quot;);
    template.save(sunil);
</code></pre></div><div class="highlight"><pre><code class="language-text" data-lang="text">It&#39;s curious to know by a simple unit test that the second way is performing almost 30 times better than the first way in persisting just the relationship. I looked at the source code for both the ways, I noticed that the first way fetches the persistent state of both the start and the end nodes and then tries to establish a relation between the two. The second option just tries to create the relation directly on the employee which is already persisted. Clearly given a scenario that we have two persisted nodes and we need to create the relationship we must always go with the option2 in my opinion. This can greatly improve the performance. The only scenario that I can think of using the first option can be that we have to allow duplicate relationships between nodes which can generally happen when relationship entities are very rich ie have a lot of properties.




## Comments

**[Santiago Baldrich](#7238 &quot;2012-01-30 22:08:37&quot;):** I&#39;m having a little trouble trying to create a relationship between two already persisted entities. The case is like this: I&#39;ve got some users and activities, both annotated with @NodeEntity. I&#39;ve created 10 users and 10 activities using a repository for each type, and now want to create a relation &quot;ASSISTS&quot; between say user 0 and activity 9. When trying to add the activity to the set of activities on the user entity, I get a NotInTransaction exception. Could you please help me?

**[Sunil Prakash Inteti](#7253 &quot;2012-01-31 10:03:37&quot;):** Santiago, this exception occurs when some mutating operations that requires a transaction are performed when no transaction is available. My guess is the relationship creation part is not under any trnasaction. So when you add a new assist relationship make sure you put that in transaction programatically. Transaction tx = graphDb.beginTx(); try { ... // any operation that works with the node space tx.success(); } finally { tx.finish(); } Hope this helps :)
</code></pre></div>

                <hr>

                <div id="disqus_thread"></div>
<script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'xebiaww'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

                <hr>

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2012/01/23/mongodb-replica-set-on-openshift-flex/" data-toggle="tooltip" data-placement="top" title="Mongodb Replica Set On Openshift Flex">&larr; Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2012/01/25/what-made-me-to-choose-cxf-over-axis2/" data-toggle="tooltip" data-placement="top" title="What Made Me To Choose Cxf Over Axis2">Next Post &rarr;</a>
                    </li>
                    
                </ul>

            </div>
        </div>
    </div>
</article>

<hr>


    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="https://twitter.com/XebiaIndia">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://www.facebook.com/XebiaIndia">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://github.com/xebiaww">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
                <p class="copyright text-muted">Copyright &copy; Xebia Blog 2015</p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/clean-blog.min.js "></script>


</body>

</html>
